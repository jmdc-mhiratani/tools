### **ツール仕様書 (v6 - 修正版)**

#### 1. ツール名
`CSV2XLSX_IC`

#### 2. 概要
CSVファイルとExcel (XLSX) ファイルの相互変換を行うWindows向けデスクトップアプリケーション。
ドラッグ＆ドロップによる簡単な操作と、文字コードの自動判別機能を特長とします。

#### 3. インターフェース
*   グラフィカルユーザーインターフェース (GUI)

#### 4. 機能要件

##### 4.1. 共通要件
*   **ファイル入力:**
    *   **ドラッグ＆ドロップ:** アプリケーションの指定エリアにファイル（CSV/XLSX）をドラッグ＆ドロップして追加できる。
    *   **ファイル選択ダイアログ:** ファイル選択ダイアログからも追加可能。
*   **文字コード対応:**
    *   **自動判別:** UTF-8での読み込みを優先し、失敗した場合はShift_JISで再試行する。
    *   **手動指定:** GUI上でユーザーが明示的に文字コード（UTF-8 / Shift_JIS）を指定することも可能。
*   **CSV形式への対応 (方言/Dialect):**
    *   フィールドが引用符（シングル/ダブルクォート）で囲まれているかにかかわらず、一般的なCSV形式に対応する。
*   **出力先:**
    *   変換後のファイルは、入力ファイルと同じフォルダに、エクセルファイルとして保存される。

#### 1. ツール名
`CSV2XLSX_IC`

#### 2. 概要
CSVファイルとExcel (XLSX) ファイルの相互変換を行うWindows向けデスクトップアプリケーション。
ドラッグ＆ドロップによる簡単な操作と、文字コードの自動判別機能を特長とします。

#### 3. インターフェース
*   グラフィカルユーザーインターフェース (GUI)

#### 4. 機能要件

##### 4.1. 共通要件
*   **ファイル入力:**
    *   **ドラッグ＆ドロップ:** アプリケーションの指定エリアにファイル（CSV/XLSX）をドラッグ＆ドロップして追加できる。
    *   **ファイル選択ダイアログ:** ファイル選択ダイアログからも追加可能。
*   **文字コード対応:**
    *   **自動判別:** UTF-8での読み込みを優先し、失敗した場合はShift_JISで再試行する。
    *   **手動指定:** GUI上でユーザーが明示的に文字コード（UTF-8 / Shift_JIS）を指定することも可能。
*   **CSV形式への対応 (方言/Dialect):**
    *   フィールドが引用符（シングル/ダブルクォート）で囲まれているかにかかわらず、一般的なCSV形式に対応する。
*   **出力先:**
    *   変換後のファイルは、入力ファイルと同じフォルダに、エクセルファイルとして保存される。

##### 4.2. CSV から XLSX への変換仕様
*   **入力:** 複数のCSVファイル。
*   **変換ロジック:**
    *   入力された複数のCSVファイルを、それぞれ別々のシートとして**1つのXLSXファイル**に統合する。
    *   各CSVの1行目は、Excelシートのヘッダー（列名）として扱われる。
    *   Excelのシート名は、元のCSVファイル名（拡張子なし）が自動で設定される。
    *   **複数シートへの書き出しロジック:**
        *   GUIまたはCLIで指定された基準（例: 特定の列の値に基づいてシートを分ける、特定の行数ごとにシートを分ける）に従い、CSVデータを複数のシートに分割して書き出すことが可能。
*   **出力ファイル名:**
    *   リストに追加された最初のCSVファイル名に基づき、出力XLSXファイル名が自動的に決定される。
    *   例: `data1.csv`, `data2.csv` を入力 → `data1.xlsx` が生成される。

##### 4.3. XLSX から CSV への変換仕様
*   **入力:** 1つのXLSXファイル。
*   **変換ロジック:**
    *   入力されたXLSXファイルに含まれる**全てのシート**を、それぞれ**個別のCSVファイル**として書き出す。
    *   各シートの1行目（ヘッダー行）が、CSVファイルの1行目に出力される。
*   **出力ファイル名:**
    *   出力されるCSVファイル名は `[元のExcelファイル名]_[シート名].csv` の形式で自動生成される。
    *   例: `sample.xlsx` (シート: `users`, `logs`) を入力 → `./sample_users.csv` と `./sample_logs.csv` が生成される。
*   **出力フォーマットの指定:**
    *   GUIまたはCLIで、出力するCSVの日付/時刻フォーマットおよび数値フォーマットを指定可能とする。

#### 5. GUI画面仕様
*   **画面レイアウト案:**
    1.  **ファイル選択エリア:**
        *   「ここにCSVまたはXLSXファイルをドラッグ＆ドロップ」というリストボックス領域。
        *   `[ファイルを選択]` ボタンも併設。
        *   ※入力されたファイル種別（CSV/XLSX）に応じて、変換モードが自動的に切り替わる。CSVとXLSXの混在は不可。
    2.  **出力設定エリア:**
        *   `出力情報:` 読み取り専用のテキストボックスに、自動生成された出力パス（単一ファイルの場合）または出力先フォルダ（複数ファイルの場合）が表示される。
    3.  **オプションエリア:**
        *   `文字コード:` ドロップダウンリスト (`自動 (UTF-8優先)` / `UTF-8` / `Shift_JIS`)。
    4.  **実行エリア:**
        *   `[変換実行]` ボタンとステータスバー。

#### 6. コマンドライン仕様 (CLI)

##### 6.1. CSV → XLSX
*   `csv2xlsx <入力CSV1> [<入力CSV2>...] --output <出力XLSX> [--encoding <文字コード>]`

##### 6.2. XLSX → CSV
*   `xlsx2csv <入力XLSX> --output-dir <出力先フォルダ> [--encoding <文字コード>]`

#### 7. 非機能要件
*   **対応OS:** Windows 10 / 11
*   **開発言語:** Python (推奨バージョン: 3.9以上)
*   **処理速度:**
    *   100万行、100MB程度のCSV/XLSXファイルを30秒以内に処理できること。
    *   メモリ使用量は最大1GB程度に抑えること。
    *   GUIでは処理中にプログレスバーを表示し、進捗をユーザーに通知すること。
*   **安定性:**
    *   予期せぬエラーが発生しても、システムが停止しないこと。
    *   **エラーハンドリング:**
        *   **GUI:** エラー発生時は、ユーザーに分かりやすいメッセージボックスを表示し、必要に応じてログファイルへの出力も行う。
        *   **CLI:** エラー発生時は、標準エラー出力にエラーメッセージを出力し、非ゼロの終了コードを返す。
        *   **ログ:** 処理の成功・失敗、エラー内容、警告などをログファイルに記録する。
        *   **想定されるエラー:**
            *   ファイルが見つからない、アクセス権がない
            *   CSV/XLSXファイルのフォーマットが不正（例: CSVの列数が一致しない、XLSXが破損している）
            *   エンコーディングエラー
            *   ファイル書き込み失敗（ディスク容量不足、アクセス権など）
            *   メモリ不足など、システムリソースに関する問題
            *   不正なデータ（例: Excelのセルに収まらない長すぎる文字列）に対する挙動を定義し、必要に応じてデータの切り捨てやエラーセルとしてのマークを行う。
*   **拡張性:** 将来的な機能追加に対応できること
*   **主要ライブラリ:**
    *   GUI: Tkinter, tkinterdnd2 (推奨バージョン: >=0.1.0)
    *   データ処理: Pandas (推奨バージョン: >=1.3.0), OpenPyXL (推奨バージョン: >=3.0.0)

#### 8. テスト戦略
*   **単体テスト:**
    *   各機能単位（CSV読み込み、Excel書き出し、フォーマット変換、GUIコンポーネント、CLIコマンドなど）で実施する。
    *   主要なロジックに対して80%以上のコードカバレッジを目指す。
*   **結合テスト:**
    *   複数の機能が連携する部分（例: CSV読み込みからExcel書き出しまでの一連の流れ、GUIとバックエンドの連携）で実施する。
*   **受け入れテスト:**
    *   ユーザーが定義した要件を満たしているかを確認するため、実際のCSV/XLSXデータを用いてGUIおよびCLIの両方で実施する。
    *   特に、様々な文字コード、データ型、大規模データ、不正データに対する挙動を確認する。

#### 8. テスト戦略
*   **単体テスト:**
    *   各機能単位（CSV読み込み、Excel書き出し、フォーマット変換、GUIコンポーネント、CLIコマンドなど）で実施する。
    *   主要なロジックに対して80%以上のコードカバレッジを目指す。
*   **結合テスト:**
    *   複数の機能が連携する部分（例: CSV読み込みからExcel書き出しまでの一連の流れ、GUIとバックエンドの連携）で実施する。
*   **受け入れテスト:**
    *   ユーザーが定義した要件を満たしているかを確認するため、実際のCSV/XLSXデータを用いてGUIおよびCLIの両方で実施する。
    *   特に、様々な文字コード、データ型、大規模データ、不正データに対する挙動を確認する。

#### 8. テスト戦略
*   **単体テスト:**
    *   各機能単位（CSV読み込み、Excel書き出し、フォーマット変換、GUIコンポーネント、CLIコマンドなど）で実施する。
    *   主要なロジックに対して80%以上のコードカバレッジを目指す。
*   **結合テスト:**
    *   複数の機能が連携する部分（例: CSV読み込みからExcel書き出しまでの一連の流れ、GUIとバックエンドの連携）で実施する。
*   **受け入れテスト:**
    *   ユーザーが定義した要件を満たしているかを確認するため、実際のCSV/XLSXデータを用いてGUIおよびCLIの両方で実施する。
    *   特に、様々な文字コード、データ型、大規模データ、不正データに対する挙動を確認する。

## 成果物
- ソースコード
- 設計書
- テスト仕様書
- 利用マニュアル

##### 4.3. XLSX から CSV への変換仕様
*   **入力:** 1つのXLSXファイル。
*   **変換ロジック:**
    *   入力されたXLSXファイルに含まれる**全てのシート**を、それぞれ**個別のCSVファイル**として書き出す。
    *   各シートの1行目（ヘッダー行）が、CSVファイルの1行目に出力される。
*   **出力ファイル名:**
    *   出力されるCSVファイル名は `[元のExcelファイル名]_[シート名].csv` の形式で自動生成される。
    *   例: `sample.xlsx` (シート: `users`, `logs`) を入力 → `./sample_users.csv` と `./sample_logs.csv` が生成される。
*   **出力フォーマットの指定:**
    *   GUIまたはCLIで、出力するCSVの日付/時刻フォーマットおよび数値フォーマットを指定可能とする。

#### 5. GUI画面仕様
*   **画面レイアウト案:**
    1.  **ファイル選択エリア:**
        *   「ここにCSVまたはXLSXファイルをドラッグ＆ドロップ」というリストボックス領域。
        *   `[ファイルを選択]` ボタンも併設。
        *   ※入力されたファイル種別（CSV/XLSX）に応じて、変換モードが自動的に切り替わる。CSVとXLSXの混在は不可。
    2.  **出力設定エリア:**
        *   `出力情報:` 読み取り専用のテキストボックスに、自動生成された出力パス（単一ファイルの場合）または出力先フォルダ（複数ファイルの場合）が表示される。
    3.  **オプションエリア:**
        *   `文字コード:` ドロップダウンリスト (`自動 (UTF-8優先)` / `UTF-8` / `Shift_JIS`)。
    4.  **実行エリア:**
        *   `[変換実行]` ボタンとステータスバー。

#### 6. コマンドライン仕様 (CLI)

##### 6.1. CSV → XLSX
*   `csv2xlsx <入力CSV1> [<入力CSV2>...] --output <出力XLSX> [--encoding <文字コード>]`

##### 6.2. XLSX → CSV
*   `xlsx2csv <入力XLSX> --output-dir <出力先フォルダ> [--encoding <文字コード>]`

#### 7. 非機能要件
*   **対応OS:** Windows 10 / 11
*   **開発言語:** Python (推奨バージョン: 3.9以上)
*   **処理速度:**
    *   100万行、100MB程度のCSV/XLSXファイルを30秒以内に処理できること。
    *   メモリ使用量は最大1GB程度に抑えること。
    *   GUIでは処理中にプログレスバーを表示し、進捗をユーザーに通知すること。
*   **安定性:**
    *   予期せぬエラーが発生しても、システムが停止しないこと。
    *   **エラーハンドリング:**
        *   **GUI:** エラー発生時は、ユーザーに分かりやすいメッセージボックスを表示し、必要に応じてログファイルへの出力も行う。
        *   **CLI:** エラー発生時は、標準エラー出力にエラーメッセージを出力し、非ゼロの終了コードを返す。
        *   **ログ:** 処理の成功・失敗、エラー内容、警告などをログファイルに記録する。
        *   **想定されるエラー:**
            *   ファイルが見つからない、アクセス権がない
            *   CSV/XLSXファイルのフォーマットが不正（例: CSVの列数が一致しない、XLSXが破損している）
            *   エンコーディングエラー
            *   ファイル書き込み失敗（ディスク容量不足、アクセス権など）
            *   メモリ不足など、システムリソースに関する問題
            *   不正なデータ（例: Excelのセルに収まらない長すぎる文字列）に対する挙動を定義し、必要に応じてデータの切り捨てやエラーセルとしてのマークを行う。
*   **拡張性:** 将来的な機能追加に対応できること
*   **主要ライブラリ:**
    *   GUI: Tkinter, tkinterdnd2 (推奨バージョン: >=0.1.0)
    *   データ処理: Pandas (推奨バージョン: >=1.3.0), OpenPyXL (推奨バージョン: >=3.0.0)